<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Prototypical</title>
    <link href="node.html" rel="import" />
    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <!--<script src="ipfs.min.js"></script>-->
    <script src="ipfs.js"></script>
</head>
<body>
    <proto-node></proto-node>
</body>
<style>
    html {
        background: #fffff8;
    }
    proto-node {
        display: block;
    }
</style>
<script>
    const index = "index.html"
    const key = "prototypical"
    const rootNode = document.querySelector("proto-node")
    let loading = false

    // Save
    async function save(node) {
        const { name } = rootNode
        const files = await IPFS.add(node, rootNode.save(null))
        console.log(files)
        files
            .filter(({ path }) => path.split("/").pop() !== index)
            .forEach(({ path, hash }) =>
                path.split("/")
                    .slice(1)
                    .reduce((parent, name) => parent.getChild(name), rootNode)
                    .setHash(hash))
        const { hash } = files.find(({ path }) => path === name)
        loading = true
        rootNode.name = hash
        location.hash = hash
//        localStorage.setItem(key, hash)
    }

    // Load
    async function load(node) {
        const { hash } = location
        const path = hash.slice(1)
        if (path.length === 46) {
            if (loading) {
                loading = false
            } else {
//                localStorage.setItem(key, path)
                const data = await IPFS.collect(node, path)
                rootNode.name = path
                rootNode.load(data)
            }
        } else {
//            const hash = localStorage.getItem(key)
//            if (hash && hash.length === 46) {
//                loading = true
//                location.hash = hash
//                const data = await IPFS.collect(node, hash)
//                rootNode.name = hash
//                rootNode.load(data)
//            } else {
                rootNode.name = key
                rootNode.load(null)
                rootNode.locked = false
//            }
        }
    }

    // Initialize
    async function initialize() {
        // IFPS
        const node = await IPFS.create()
        window.node = node
        // Events
        // TODO: some shit
        window.addEventListener("beforeunload", event => null)
        window.addEventListener("hashchange", event => load(node))
        window.addEventListener("keydown", event => {
            const { keyCode, metaKey, ctrlKey } = event
            // TODO: platform detection
            if (keyCode === 83 && (metaKey || ctrlKey)) {
                event.preventDefault()
                save(node)
            }
        })

        await load(node)
    }

    initialize()

</script>

</html>