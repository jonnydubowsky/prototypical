<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Prototypical</title>
    <link href="node.html" rel="import" />
    <script src="https://unpkg.com/ipfs/dist/index.min.js"></script>
    <!--<script src="ipfs.min.js"></script>-->
    <script src="ipfs.js"></script>
</head>
<body>
    <proto-node></proto-node>
</body>
<style>
    html {
        background: #fffff8;
    }
    proto-node {
        display: block;
    }
</style>
<script>
    const index = "index.html"
    const key = "prototypical"
    const rootNode = document.querySelector("proto-node")
    let loading = false

    // Save
    async function save(node) {
        const { name } = rootNode
        const tree = rootNode.save(null)
        console.log(tree)
        const files = await IPFS.add(node, tree)
        setHashes(files)
        const { hash } = files.find(({ path }) => path === name)
        loading = true
        rootNode.name = hash
        location.hash = hash
    }

    function setHashes(files) {
        files
            .map(({ path, hash }) => ({ path: path.split("/").slice(1), hash }))
            .filter(({ path }) => path[path.length - 1] !== index)
            .forEach(({ path, hash }) =>
                path.reduce((root, name) =>
                    root.getChild(name), rootNode).setHash(hash))
    }

    // Load
    async function load(node) {
        const { hash } = location
        const path = hash.slice(1)
        if (path.length === 46) {
            if (loading) {
                loading = false
            } else {
                const files = await IPFS.collect(node, path)
                const map = {}
                files.forEach(({path, text}) => {
                    if (path !== undefined) {
                        const [root, ...route] = path.split("/")
                        const name = route.pop()
                        if (name !== undefined) {
                            const directory = route.reduce((parent, child) => parent[child], map)
                            directory[name] = text === undefined ? {} : text
                        }
                    }
                })
                rootNode.name = path
                rootNode.load(map)
                setHashes(files)
            }
        } else {
            rootNode.name = key
            rootNode.load(null)
            rootNode.locked = false
        }
    }

    // Initialize
    async function initialize() {
        // IFPS
        const node = await IPFS.create()
        window.node = node
        // Events
        // TODO: some shit
        window.addEventListener("beforeunload", event => null)
        window.addEventListener("hashchange", event => load(node))
        window.addEventListener("keydown", event => {
            const { keyCode, metaKey, ctrlKey } = event
            // TODO: platform detection
            if (keyCode === 83 && (metaKey || ctrlKey)) {
                event.preventDefault()
                save(node)
            }
        })

        await load(node)
    }

    initialize()

</script>

</html>