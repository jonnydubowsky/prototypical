<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Prototypical</title>
    <link href="ipfs.html" rel="import" />
    <link href="header.html" rel="import" />
    <link href="editor.html" rel="import" />
</head>
<style>
    html {
        background: #fffff8;
    }
</style>
<body>
    <proto-header id="header" locked="true" saved="true"></proto-header>
    <hr />
    <proto-editor id="editor" locked="true"></proto-editor>
</body>
<script>
    // Constants
    const saveMessage = "Changes you made may not be saved."
    const commitMessage = "Enter a commit message"

    // Elements
    const header = document.getElementById("header")
    const editor = document.getElementById("editor")

    // State
    const state = {
        hash: null,
        node: null,
        saved: true,
        locked: true,
    }

    const update = {
        hash(hash) {
            state.hash = hash
            history.replaceState({hash}, hash, `#/${hash || ""}`)
            header.setAttribute("hash", hash || "")
        },
        node(node) {
            state.node = node
            header.setAttribute("node", node)
        },
        saved(saved) {
            state.saved = saved
            header.setAttribute("saved", saved)
        },
        locked(locked) {
            state.locked = locked
            header.setAttribute("locked", locked)
            editor.setAttribute("locked", locked)
            editor.focusContent()
        }
    }

    // Save
    async function save(node) {
        const message = prompt(commitMessage)
        if (message !== null) {
            const { content } = editor
            const parent = state.hash
            const time = Date.now()
            const payload = { message, content, parent, time }
            const hash = await IPFS.add(node, JSON.stringify(payload))
            update.hash(hash)
            update.saved(true)
        }
    }

    // Load
    async function load(node, hash) {
        const { content } = JSON.parse(await IPFS.cat(node, hash))
        editor.content = content
        editor.focusContent()
        update.hash(hash)
        update.saved(true)
    }

    // Initialize
    async function initialize() {
        const node = await IPFS.create()
        const { id } = await node.id()
        update.node(id)

        // Events
        header.addEventListener("lock", event => update.locked(!state.locked))
        header.addEventListener("save", event => save(node))
        editor.addEventListener("input", event => state.saved && update.saved(false))
        window.addEventListener("beforeunload", event => state.saved ? null : saveMessage)
        window.addEventListener("keydown", event => {
            const { keyCode, metaKey, ctrlKey } = event
            // TODO: platform detection
            if (keyCode === 83 && (metaKey || ctrlKey)) {
                event.preventDefault()
                save(node)
            }
        })

        // Initialize hash
        const { hash } = location
        if (hash.length === 48 && hash.slice(0, 2) === "#/") {
            load(node, hash.slice(2))
        } else {
            update.hash(null)
        }
    }

    initialize()

</script>

</html>