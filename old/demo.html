<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Collusion</title>
    <link rel="stylesheet" href="codemirror/codemirror.css"/>
    <link rel="import" href="codemirror/index.html" />
</head>
<style>
    .cm-transclusion {
        color: green;
        font-weight: bold;
    }
    .CodeMirror {
        height: auto;
    }
    .proto-node {
        display: block;
    }
</style>
<body>
<proto-node>
# Hello world
#[Thing](QmPTkMuuL6PD8L2SwTwbcs1NPg14U8mRzerB1ZrrBrkSDD)
</proto-node>
</body>
<script>
    class ProtoNode extends HTMLElement {
        constructor() {
            super()
            const text = this.textContent
            this.textContent = ""
            this.main = document.createElement("main")
            this.appendChild(this.main)
            this.header = document.createElement("header")
            this.main.appendChild(this.header)
            this.header.textContent = "this is a header"
            this.doc = new CodeMirror.Doc(text, "markdown", 0)
            this.cm = CodeMirror(this.main, {value: this.doc})
            this.doc.eachLine(lineHandle => {
                console.log(lineHandle)
                if (lineHandle.stateAfter.transclusion) {
                    console.log(lineHandle.stateAfter.transclusion)
                    const { widgets } = this.doc.lineInfo(lineHandle)
                    if (widgets) {
                        // Great!
                    } else {
                        // Oh no!
                        const options = {}
                        const node = document.createElement("div")
                        node.innerHTML = "<proto-node>Wow this is cool</proto-node>"
                        this.doc.addLineWidget(lineHandle, node, options)
                    }
                    console.log(widgets)
                }
            })
        }
    }
    customElements.define("proto-node", ProtoNode)
</script>
</html>