<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Prototypical</title>
    <link href="node.html" rel="import" />
    <script src="ipfs.min.js"></script>
    <script src="codemirror/codemirror.js"></script>
    <link rel="stylesheet" href="codemirror/codemirror.css"/>
    <script src="ipfs.js"></script>
</head>
<body></body>
<style>
    html {
        background: #fffff8;
    }
    proto-node {
        display: block;
    }
</style>
<script>
    const key = "prototypical"
    const rootNode = document.createElement("proto-node")
    document.body.appendChild(rootNode)

    let loading = false
    let saved = true

    // Save
    async function save(node, deep) {
        const { name } = rootNode
        const files = await IPFS.add(node, rootNode.save(null))
        const { hash } = files.find(({ path }) => path === name)
        loading = true
        rootNode.name = hash
        location.hash = hash
        localStorage.setItem(key, hash)
    }

    // Load
    async function load(node) {
        const path = location.hash.slice(1)
        if (path.length === 46) {
            if (loading) {
                loading = false
            } else {
                loading = true
                localStorage.setItem(key, path)
                const data = await IPFS.collect(node, path)
                rootNode.name = path
                rootNode.load(data)
            }
        } else {
            const hash = localStorage.getItem(key)
            if (hash && hash.length === 46) {
                loading = true
                location.hash = hash
                const data = await IPFS.collect(node, hash)
                rootNode.name = hash
                rootNode.load(data)
            } else {
                rootNode.name = key
                rootNode.load(null)
                rootNode.locked = false
            }
        }
    }

    const { platform } = navigator
    const macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K']
    const mac = macosPlatforms.includes(platform)
    const windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE']
    const win = windowsPlatforms.includes(platform)
    const iosPlatforms = ['iPhone', 'iPad', 'iPod']
    const ios = iosPlatforms.includes(platform)


    IPFS.create().then(node => {
        window.node = node
        window.addEventListener("beforeunload", event => {
            if (!saved) {

            }
        })
        window.addEventListener("hashchange", event => {
            if (!loading) {
                load(node)
            }
        })
        window.addEventListener("keydown", event => {
            const { keyCode, metaKey, ctrlKey, shiftKey } = event
            if (keyCode === 83 && (mac ? metaKey : ctrlKey)) {
                event.preventDefault()
                save(node, shiftKey)
            }
        })

        load(node)
    })

</script>

</html>